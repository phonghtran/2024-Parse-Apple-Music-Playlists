<%- include ('../partials/head.ejs') %>

    <style>
        #main {
            margin: 0 1rem;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        th {
            background: linear-gradient(135deg, var(--colorSecondary1) 0%, #7a1fa0 100%);
            color: var(--colorBackground);
            font-weight: var(--weightBold);
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        th:first-child {
            border-top-left-radius: 0.75rem;
        }

        th:last-child {
            border-top-right-radius: 0.75rem;
        }

        td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid rgba(142, 36, 170, 0.1);
            min-width: auto;
            font-size: 0.8em;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:nth-child(even) {
            background-color: rgba(142, 36, 170, 0.05);
        }

        #tableCount {
            margin: 1rem 0;
            padding: 0.6rem 0.8rem;
            background: linear-gradient(135deg, var(--colorSecondary2) 0%, #a068d4 100%);
            color: var(--colorBackground);
            border-radius: 0.5rem;
            display: inline-block;
            font-weight: var(--weightBold);
            box-shadow: 0 2px 6px rgba(142, 36, 170, 0.2);
        }

        #tabs {
            display: flex;
            gap: 0;
            margin: 1rem;
            position: relative;
        }

        #tabs hr {
            left: 0;
            bottom: 0;
            position: absolute;
            z-index: -1;
        }
    </style>
    </head>

    <body>


        <%- include ('../partials/nav.ejs') %>

            <!-- <p>"npm run dev" // "rs" to restart server live</p>
 -->


            <div id="filter">
                <div class="bttnrange">

                    <button id="bttnSortPlaylist" class="active bttnFetchRows bttnrangeBttn" data-label="playlist">Sort
                        by
                        Playlist</button>
                    <button id="bttnSortArtist" class="bttnFetchRows bttnrangeBttn" data-label="artist">Sort by
                        Artist</button>
                    <button id="bttnSortName" class="bttnFetchRows bttnrangeBttn" data-label="name">Sort by Song
                        Name</button>
                    <button id="bttnGenre" class="bttnFetchRows bttnrangeBttn" data-label="genre">Sort by Genre</button>
                    <button id="bttnSortDB" class="bttnFetchRows bttnrangeBttn" data-label="db">Sort by DB</button>
                    <button id="bttnPairedName" class="bttnFetchRows bttnrangeBttn" data-label="pairedName">Sort by
                        Paired
                        Name</button>
                </div>
            </div>

            <div id="main">
                <p id="tableCount"></p>
                <table id="tracks"></table>
            </div>

            <script>
                console.log('fetching')

                let tablecount = 0;
                let sortType = 'playlist'
                fetchTable()



                const bttnFetchRows = document.getElementsByClassName("bttnFetchRows")

                for (var i = 0; i < bttnFetchRows.length; i++) {
                    bttnFetchRows[i].addEventListener('click', (e) => {
                        // console.log(e)
                        sortType = e.srcElement.dataset.label

                        const bttnIsActive = document.getElementsByClassName("bttnFetchRows")


                        for (var j = 0; j < bttnIsActive.length; j++) {
                            bttnIsActive[j].classList.remove('active')
                        }


                        e.srcElement.classList.add('active')
                        fetchTable()
                    })
                }






                function fetchTable() {
                    const tracksDiv = document.getElementById('tracks');
                    tracksDiv.innerHTML = ''

                    fetch(`/tracks?sort=${sortType}`)
                        .then(response => {
                            if (response.ok) { // Check if response is OK (200-299)
                                return response.json(); // If true, return the JSON data
                            } else {
                                throw new Error(`Error ${response.status}: ${response.statusText}`); // Otherwise, rethrow an error
                            }

                        })
                        .then(data => {
                            const tracksDiv = document.getElementById('tracks');
                            tracksDiv.innerHTML = ''
                            // console.log(data)
                            const trackRow = document.createElement('tr');
                            for (label in data[0]) {
                                const t1 = document.createElement('th');
                                t1.textContent = label
                                trackRow.appendChild(t1)
                            }
                            tracksDiv.appendChild(trackRow);

                            // tracksDiv.innerHTML = '<tr><th>ID</th><th>Playlist Name</th><th>Track Position</th><th>Artist</th><th>Name</th><th>Genre</th><th>Paired Name</th></tr>'
                            rows = Object.keys(data).length

                            const tableCount = document.getElementById('tableCount')
                            // console.log(rows)
                            tableCount.innerHTML = `${rows} rows`

                            // let debug = 0
                            data.forEach(track => {
                                // console.log(track)
                                const trackRow = document.createElement('tr');

                                // if (debug === 0) {
                                //     debug++
                                //     console.log(track)
                                // }

                                for (columns in track) {
                                    const column = track[columns]


                                    const t1 = document.createElement('td');
                                    t1.textContent = (columns === 'pairedName' || columns === 'genre') ? column.slice(0, 18) + 'â€¦' : column
                                    trackRow.appendChild(t1)
                                }

                                tracksDiv.appendChild(trackRow);
                            });
                        })
                        .catch(error => console.error('Error fetching tracks:', error))
                        ;
                }// fetch table
            </script>
    </body>

    </html>